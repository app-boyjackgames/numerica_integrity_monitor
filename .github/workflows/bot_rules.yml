name: Issue Moderation Bot

on:
  schedule:
    # каждые 5 минут (пример из диапазона 2-59 минут)
    - cron: "*/5 * * * *"
    # каждый 3 час (пример из диапазона 1-6 часов)
    - cron: "0 */3 * * *"
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  moderate:
    runs-on: ubuntu-latest

    steps:
      - name: Check Issues
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const forbiddenWords = [
              "добавление",
              "исправление ошибок",
              "изменить",
              "удалена"
            ];

            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open"
            });

            const now = new Date();

            for (const issue of issues) {

              // Пропустить PR
              if (issue.pull_request) continue;

              const text = (issue.title + " " + (issue.body || "")).toLowerCase();

              const hasForbidden = forbiddenWords.some(word => text.includes(word));

              if (!hasForbidden) continue;

              // Проверяем, есть ли уже label warning
              const hasWarningLabel = issue.labels.some(label => label.name === "warning");

              if (!hasWarningLabel) {

                // Добавить label
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issue.number,
                  labels: ["warning"]
                });

                // Написать комментарий
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: "⚠️ **ПРЕДУПРЕЖДЕНИЕ:** Нельзя использовать этот добавить, исправление ошибок, изменить, удалена. А потому что уже была закрыта..."
                });

              } else {

                // Проверяем прошло ли 2 минуты
                const createdAt = new Date(issue.created_at);
                const diffMinutes = (now - createdAt) / (1000 * 60);

                if (diffMinutes >= 2) {

                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issue.number,
                    state: "closed"
                  });

                }
              }
            }
